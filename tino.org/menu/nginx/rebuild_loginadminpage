# @author: Lãng Tử Cô Độc
# @website:  https://tinohost.com, https://kienthuclinux.com
# @since: 2020clear
system_version=$(rpm -E %{rhel})

echo ""
echo "====================================================================================="
echo "Menu Board > Manage Nginx > Rebuild Vhost Domain "
echo "/-------------------------/"
echo "- Change PHP Version for Domain"
echo "/-----------------------------------------------------------------------------------/"
server_ip=$(dig -4 TXT +short o-o.myaddr.l.google.com @ns1.google.com | sed -e 's/\"//g')


admin_port="7979"
sock_tino=$(php -v | head -n 1 | cut -d " " -f 2 | cut -f1-2 -d"." |  sed -e 's/\.//g')

mkdir -p /var/log/nginx/


cat > "/etc/nginx/conf.d/vhosts/phpmyadmin.conf" <<END
upstream netdata {
server 127.0.0.1:19999;
keepalive 64;
}
server {
	listen $admin_port default_server;
	server_name _;
	root /opt/tinopanel/private_html;
	access_log /var/log/nginx/default-access_log;
	error_log /var/log/nginx/default-error_log warn;
 #   modsecurity on;
 #   modsecurity_rules_file /etc/nginx/modsec/main.conf;
    satisfy any;
    allow 127.0.0.1;
    deny all;
 
	auth_basic "Restricted";
	auth_basic_user_file /opt/tinopanel/ssl/.htpasswd;
	if (\$bad_bot) { return 444; }
	
	server_name_in_redirect off;

	#include conf.d/custom/restrictions.conf;
	#include conf.d/custom/pagespeed.conf;


  location /vts_status {
    vhost_traffic_status_bypass_limit on;
    vhost_traffic_status_bypass_stats on;
    vhost_traffic_status_display;
    vhost_traffic_status_display_format html;
  }
	
	location /stub_status {
	stub_status;
	allow 127.0.0.1;	#only allow requests from localhost
	deny all;
	}
	 
	location /nginx_status {
        stub_status on;
        access_log off;
        include conf.d/custom/admin-ips.conf; deny all;
    } 
      location /netdata {
        return 301 /netdata/;
   }

   location ~ /netdata/(?<ndpath>.*) {
        proxy_redirect off;
        proxy_set_header Host \$host;

        proxy_set_header X-Forwarded-Host \$host;
        proxy_set_header X-Forwarded-Server \$host;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_pass_request_headers on;
        proxy_set_header Connection "keep-alive";
        proxy_store off;
        proxy_pass http://netdata/\$ndpath\$is_args\$args;

    }


    location ~ ^/(status|ping)\$ {
	fastcgi_pass php; 
       access_log off;
    }
    	include conf.d/custom/fpm-default.conf;
}
END

cat > "/etc/nginx/nginx.conf" <<END
user nginx nginx;
worker_processes auto;
worker_rlimit_nofile 8192;

error_log /var/log/nginx/error.log notice;
pid /var/run/nginx.pid;
include /usr/share/nginx/modules/*.conf;
pcre_jit on;

events
{
	worker_connections 1024;
	use epoll;
}

http
{
	server_names_hash_max_size 2048;
	server_tokens off;
	more_set_headers 'Server: tino-panel';
	vhost_traffic_status_zone;

	geoip2 /usr/share/GeoIP/GeoLite2-Country.mmdb
	{
		auto_reload 60m;
		\$geoip2_metadata_country_build metadata build_epoch;
		\$geoip2_data_country_code country iso_code;
		\$geoip2_data_country_name country names en;
	}
	geoip2 /usr/share/GeoIP/GeoLite2-City.mmdb
	{
		auto_reload 60m;
		\$geoip2_metadata_city_build metadata build_epoch;
		\$geoip2_data_city_name city names en;
	}

	add_header X-GeoCountry \$geoip2_data_country_name;
	add_header X-GeoCode \$geoip2_data_country_code;
	add_header X-GeoCity \$geoip2_data_city_name;

	map \$geoip2_data_country_code \$allowed_country
	{
		default yes;
		VN yes;
		US yes;
	}


	geo \$whitelist
	{
		default 0;
		# CIDR in the list below are not limited
		1.2.3.0/24 1;
		9.10.11.12/32 1;
		127.0.0.1/32 1;
		#     $server_ip 1;
	}

	map \$whitelist \$limit
	{
		0 \$binary_remote_addr;
		1 "";
	}


	map \$http_host \$blogid
	{
		default -999;
	}
	geo \$allowed_ip
	{
		default yes;
		127.0.0.1 yes;
		192.168.1.0/24 yas;
	}
	server_names_hash_bucket_size 1024;

	include /etc/nginx/mime.types;
	default_type application/octet-stream;

	log_format main '\$remote_addr - \$remote_user [\$time_local] "\$request" '
	'\$status \$body_bytes_sent "\$http_referer" '
	'"\$http_user_agent" "\$http_x_forwarded_for" '
	'\$request_time \$upstream_response_time \$pipe';

	disable_symlinks if_not_owner;

	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;
	types_hash_max_size 2048;
	variables_hash_max_size 1024;
	variables_hash_bucket_size 128;

	keepalive_requests 300;
	keepalive_timeout 30;

	client_body_temp_path /var/lib/nginx/cache/client_body 1 2;
	client_max_body_size 512M;
	client_body_buffer_size 2048k;
	client_body_timeout 30s;
	client_header_timeout 30s;

	connection_pool_size 256;


	## Include Gzip-brotli
	include /etc/nginx/gzip.conf;

	## General Options
	index index.html index.php;
	charset UTF-8;
	ignore_invalid_headers on;

	## pagespeed options
	include /etc/nginx/pagespeed.conf;

	## proxy - fast cgi options
	include /etc/nginx/proxy.conf;


	upstream php
	{
		#server 127.0.0.1:9000;
		server unix:/dev/shm/tinopanel.$sock_tino.sock;
	}

	include /etc/nginx/conf.d/vhosts/*.conf;
	include /etc/nginx/conf.d/custom/blacklist.conf;
	include /etc/nginx/conf.d/custom/cloudflare.conf;
}
END

cat > "/etc/nginx/gzip.conf" <<END
    brotli on;
    brotli_static on;
    brotli_buffers 16 8k;
    brotli_comp_level 6;
    brotli_types
        text/css
        text/javascript
        text/xml
        text/plain
        text/x-component
        application/javascript
        application/x-javascript
        application/json
        application/xml
        application/rss+xml
        application/vnd.ms-fontobject
        font/truetype
        font/opentype
        image/svg+xml;
        
    gzip on;
    gzip_disable "MSIE [1-6]\.";
    gzip_static on;
    gzip_comp_level 9;
    gzip_http_version 1.1;
    gzip_proxied any;
    gzip_vary on;
    gzip_buffers 16 8k;
    gzip_min_length 1100;
    gzip_types
        text/css
        text/javascript
        text/xml
        text/plain
        text/x-component
        application/javascript
        application/x-javascript
        application/json
        application/xml
        application/rss+xml
        application/vnd.ms-fontobject
        font/truetype
        font/opentype
        image/svg+xml;
END

cat > "/etc/nginx/pagespeed.conf" <<END
    pagespeed off;
    pagespeed FileCachePath /var/lib/nginx/cache/pagespeed;
    pagespeed FileCacheSizeKb 204800;
    pagespeed FileCacheCleanIntervalMs 3600000;
    pagespeed FileCacheInodeLimit 100000;
    pagespeed MemcachedThreads 1;
    pagespeed MemcachedServers "localhost:11211";
    pagespeed MemcachedTimeoutUs 100000;
    pagespeed RewriteLevel CoreFilters;
    pagespeed EnableFilters collapse_whitespace,remove_comments,extend_cache;
    pagespeed DisableFilters combine_css,combine_javascript;
    pagespeed LowercaseHtmlNames on;
    pagespeed StatisticsPath /ngx_pagespeed_statistics;
    pagespeed GlobalStatisticsPath /ngx_pagespeed_global_statistics;
    pagespeed MessagesPath /ngx_pagespeed_message;
    pagespeed ConsolePath /pagespeed_console;
    pagespeed AdminPath /pagespeed_admin;
    pagespeed GlobalAdminPath /pagespeed_global_admin;
    pagespeed MessageBufferSize 100000;
    pagespeed UsePerVhostStatistics on;
    pagespeed FetchHttps enable;
    pagespeed FetchHttps enable,allow_self_signed;
    pagespeed SslCertDirectory /etc/pki/tls/certs;
    pagespeed SslCertFile /etc/pki/tls/cert.pem;
    pagespeed EnableCachePurge on;
    pagespeed InPlaceResourceOptimization on;  
END

if (( ${system_version} == 9 ));then
    echo "" > /etc/nginx/pagespeed.conf
fi


    
cat > "/etc/nginx/proxy.conf" <<END
    proxy_cache_path /var/lib/nginx/cache/proxy levels=1:2 keys_zone=PROXYCACHE:100m max_size=200m inactive=60m;
    proxy_temp_path /var/lib/nginx/cache/proxy_tmp;
    proxy_connect_timeout 30;
    proxy_read_timeout 300;
    proxy_send_timeout 300;
    proxy_buffers 16 32k;
    proxy_buffering on;
    proxy_buffer_size 64k;
    proxy_busy_buffers_size 96k;
    proxy_temp_file_write_size 96k;
    proxy_cache_key "\$scheme://\$host\$request_uri";

    fastcgi_cache_path /var/lib/nginx/cache/fastcgi levels=1:2 keys_zone=FCGICACHE:100m max_size=200m inactive=60m;
    fastcgi_temp_path /var/lib/nginx/cache/fastcgi_tmp;
    fastcgi_cache_key "\$scheme\$request_method\$host\$request_uri";
    fastcgi_cache_use_stale error timeout invalid_header http_500;
    fastcgi_ignore_headers Cache-Control Expires Set-Cookie;
    fastcgi_send_timeout 300;
    fastcgi_read_timeout 300;
    fastcgi_buffers 8 256k;
    fastcgi_buffer_size 256k;
    fastcgi_busy_buffers_size 256k;
    fastcgi_index index.php;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
    
    #limit_req_zone \$binary_remote_addr zone=wplogin:50m rate=15r/m;
	limit_req_zone       \$limit   zone=wplogin:10m  rate=60r/m;
    #limit_req            zone=wplogin burst=3;
    #limit_req_log_level  warn;
    #limit_req_status     503;
END


cat > "/etc/nginx/fastcgi.conf" <<END
fastcgi_param  SCRIPT_FILENAME    \$document_root\$fastcgi_script_name;
fastcgi_param  QUERY_STRING	  \$query_string;
fastcgi_param  REQUEST_METHOD     \$request_method;
fastcgi_param  CONTENT_TYPE	  \$content_type;
fastcgi_param  CONTENT_LENGTH     \$content_length;

fastcgi_param  SCRIPT_NAME        \$fastcgi_script_name;
fastcgi_param  REQUEST_URI        \$request_uri;
fastcgi_param  DOCUMENT_URI	  \$document_uri;
fastcgi_param  DOCUMENT_ROOT	  \$document_root;
fastcgi_param  SERVER_PROTOCOL    \$server_protocol;
fastcgi_param  REQUEST_SCHEME     \$scheme;
fastcgi_param  HTTPS              \$https if_not_empty;

fastcgi_param  GATEWAY_INTERFACE  CGI/1.1;
fastcgi_param  SERVER_SOFTWARE    nginx/\$nginx_version;

fastcgi_param  REMOTE_ADDR        \$remote_addr;
fastcgi_param  REMOTE_PORT        \$remote_port;
fastcgi_param  SERVER_ADDR        \$server_addr;
fastcgi_param  SERVER_PORT        \$server_port;
fastcgi_param  SERVER_NAME        \$server_name;

# PHP only, required if PHP was built with --enable-force-cgi-redirect
fastcgi_param  REDIRECT_STATUS    200;
END


nginx -s reload


#########################

mkdir -p /opt/antiddos

cat >  "/etc/systemd/system/antiddostino.service" <<END
[Unit]
 Description= ON - OFF anti DDOS Layer7
 
[Service]
 ExecStart=/opt/antiddos/checkload

[Install]
 WantedBy=default.target
 
END

cat > "/opt/antiddos/checkload" <<END
#!/bin/sh
while [ 1 -gt 0 ]
do
    num=\$(grep ^cpu\\scores /proc/cpuinfo | uniq |  awk '{print \$4}')
    num=$((num * 4))
    load=\$(cat /proc/loadavg |awk '{print \$1}'|cut -d "." -f1)
    
    if [ "\$load" -gt "\$num" ] && [ "\$load" -gt 10 ]; then
        /usr/sbin/migatedddos on;
        
        topnum=\$(cat /home/*/logs/access*_log | awk -v start="\$(date -d '30 minutes ago' +[%d/%b/%Y:%H:%M:%S])" -v end="\$(date +[%d/%b/%Y:%H:%M:%S])" '\$4 > start && \$4 < end' | awk '{ print \$1}' | sort | uniq -c | sort -nr | head -n 1 |  awk '{ print \$1}')
        topip=\$(cat /home/*/logs/access*_log | awk -v start="\$(date -d '30 minutes ago' +[%d/%b/%Y:%H:%M:%S])" -v end="\$(date +[%d/%b/%Y:%H:%M:%S])" '\$4 > start && \$4 < end' | awk '{ print \$1}' | sort | uniq -c | sort -nr | head -n 1 |  awk '{ print \$2}')
        
        if [ "\$topnum" -gt 3000 ]; then
			csf -e  &> /dev/null
            csf -d  "\$topip"
            echo "\$(date):\$topip:\$topnum"  >> /opt/antiddos/checkload.log
        else
            echo "\$(date)" >> /opt/antiddos/checkload.log
        fi
        
        sleep 900;
        /usr/sbin/migatedddos off;
    fi
    sleep 1;
done
END


cat >  "/usr/sbin/migatedddos" <<END
#!/bin/bash
value=\$1
if [ "\$value" == "on" ]
then
    sed -i '/testcookie\ /s/off/on/' /etc/nginx/conf.d/addon_confs/*/checkcookie.conf
    echo " migatedddos  has been enable from the vhost configuration!"

	
elif [ "\$value" == "off" ]
then
    sed -i '/testcookie\ /s/on/off/' /etc/nginx/conf.d/addon_confs/*/checkcookie.conf
    echo " migatedddos  has been disable from the vhost configuration!"
else
   echo 'Warning: Import the environment variable "on" or "off" to use!'
fi
/usr/sbin/nginx -s reload

#systemctl restart php-fpm-74.service

for D in /opt/php/*; do
	if [ -d "\${D}" ]; then #If a directory
		php=\${D##*/} # Domain name
		php_ver=\${php:3}
		php_full="php-fpm-\${php_ver}"
	
	echo "restart \$php"
	service php-fpm-\$php_ver restart
fi
done
rm -rf /var/lib/nginx/cache/fastcgi/*

END

chmod +x /etc/systemd/system/antiddostino.service
chmod +x /usr/sbin/migatedddos

systemctl enable antiddostino
systemctl start antiddostino

###################


echo ""
echo "All domain rebuild vhosts done !!!**!!!"
echo "Rebuild config login admin page done!"
sleep 2

/etc/quicklemp/menu/nginx_